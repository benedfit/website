/*!
 * Craft by Pixel & Tonic
 *
 * @package   Craft
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2013, Pixel & Tonic, Inc.
 * @license   http://buildwithcraft.com/license Craft License Agreement
 * @link      http://buildwithcraft.com
 */
(function(a){var b=Garnish.Base.extend({$alerts:null,$header:null,$nav:null,$overflowNavMenuItem:null,$overflowNavMenuBtn:null,$overflowNavMenu:null,$overflowNavMenuList:null,$notificationWrapper:null,$notificationContainer:null,$main:null,$sidebar:null,$sidebarNav:null,$sidebarNavPlaceholder:null,$altSidebar:null,$altSidebarNavBtn:null,$altSidebarNavMenu:null,$content:null,$collapsibleTables:null,navItems:null,totalNavItems:null,visibleNavItems:null,totalNavWidth:null,showingOverflowNavMenu:false,showingSidebar:true,fixedNotifications:false,fixedSidebarNav:false,tabs:null,selectedTab:null,init:function(){this.$alerts=a("#alerts");this.$header=a("#header");this.$nav=a("#nav");this.$notificationWrapper=a("#notifications-wrapper");this.$notificationContainer=a("#notifications");this.$main=a("#main");this.$sidebar=a("#sidebar");this.$sidebarNav=this.$sidebar.children("nav");this.$content=a("#content");this.$collapsibleTables=this.$content.find("table.collapsible");this.navItems=[];this.totalNavWidth=b.baseNavWidth;var c=this.$nav.children();this.totalNavItems=c.length;this.visibleNavItems=this.totalNavItems;for(var f=0;f<this.totalNavItems;f++){var h=a(c[f]),e=h.width();this.navItems.push(h);this.totalNavWidth+=e}this.addListener(Garnish.$win,"resize","onWindowResize");this.onWindowResize();this.addListener(Garnish.$win,"scroll","onWindowScroll");this.onWindowScroll();var l=this.$notificationContainer.children();l.delay(b.notificationDuration).fadeOut();this.tabs={};var g=a("#tabs a");for(var f=0;f<g.length;f++){var k=a(g[f]),d=k.attr("href");if(d&&d.charAt(0)=="#"){this.tabs[d]={$tab:k,$target:a(d)};this.addListener(k,"activate","selectTab")}if(!this.selectedTab&&k.hasClass("sel")){this.selectedTab=d}}if(document.location.hash&&typeof this.tabs[document.location.hash]!="undefined"){this.tabs[document.location.hash].$tab.trigger("click")}this.addListener(a(".formsubmit"),"activate",function(n){var m=a(n.currentTarget);if(m.data("menu")){var i=m.data("menu").$btn.closest("form")}else{var i=m.closest("form")}if(m.attr("data-action")){a('<input type="hidden" name="action" value="'+m.attr("data-action")+'"/>').appendTo(i)}if(m.attr("data-redirect")){a('<input type="hidden" name="redirect" value="'+m.attr("data-redirect")+'"/>').appendTo(i)}if(m.attr("data-confirm")){if(!confirm(m.attr("data-confirm"))){return}}i.submit()});if(this.$alerts.length){this.initAlerts()}a("input[type!=password], textarea").placeholder();var j=a('form[data-saveshortcut="1"]:first');if(j.length==1){this.addListener(Garnish.$doc,"keydown",function(i){if((i.metaKey||i.ctrlKey)&&i.keyCode==Garnish.S_KEY){j.submit();return false}return true})}},onWindowResize:function(){this.onWindowResize._cpWidth=Math.min(Garnish.$win.width(),b.maxWidth);this.updateResponsiveNav();this.updateResponsiveSidebar();this.updateResponsiveTables()},updateResponsiveNav:function(){if(this.onWindowResize._cpWidth<this.totalNavWidth){if(!this.showingOverflowNavMenu){if(!this.$overflowNavMenuBtn){this.$overflowNavMenuItem=a("<li/>").appendTo(this.$nav);this.$overflowNavMenuBtn=a('<a class="menubtn" title="'+Craft.t("More")+'">â€¦</a>').appendTo(this.$overflowNavMenuItem);this.$overflowNavMenu=a('<div id="overflow-nav" class="menu" data-align="right"/>').appendTo(this.$overflowNavMenuItem);this.$overflowNavMenuList=a("<ul/>").appendTo(this.$overflowNavMenu);new Garnish.MenuBtn(this.$overflowNavMenuBtn)}else{this.$overflowNavMenuItem.show()}this.showingOverflowNavMenu=true}if(this.$nav.height()>b.navHeight){do{this.addLastVisibleNavItemToOverflowMenu()}while((this.$nav.height()>b.navHeight)&&(this.visibleNavItems>0))}else{do{this.addFirstOverflowNavItemToMainMenu()}while((this.$nav.height()==b.navHeight)&&(this.visibleNavItems<this.totalNavItems));this.addLastVisibleNavItemToOverflowMenu()}}else{if(this.showingOverflowNavMenu){this.$overflowNavMenuItem.hide();while(this.visibleNavItems<this.totalNavItems){this.addFirstOverflowNavItemToMainMenu()}this.showingOverflowNavMenu=false}}},updateResponsiveSidebar:function(){if(!this.$sidebar.length){return}if(this.onWindowResize._cpWidth<b.minSidebarWidth){if(this.showingSidebar){this.makeSidebarNavUnfixed();this.$main.removeClass(b.hasSidebarClass);if(!this.$altSidebar){this.$altSidebar=a('<div id="sidebar-alt"/>').insertAfter(this.$sidebar);var e=this.$sidebar.children();for(var f=0;f<e.length;f++){var c=a(e[f]).clone(true);if(c.prop("nodeName")=="NAV"){var g=c.find(".sel:first").text(),d=c.children();this.$altSidebarNavBtn=a('<div class="btn menubtn">'+g+"</div>").appendTo(this.$altSidebar);this.$altSidebarNavMenu=a('<div class="menu menulist"/>').appendTo(this.$altSidebar);d.appendTo(this.$altSidebarNavMenu);new Garnish.MenuBtn(this.$altSidebarNavBtn);c.detach()}else{c.appendTo(this.$altSidebar)}}}else{this.$altSidebar.show()}this.$sidebar.hide();this.showingSidebar=false}}else{if(!this.showingSidebar){this.$main.addClass(b.hasSidebarClass);this.$altSidebar.hide();this.$sidebar.show();this.showingSidebar=true;this.updateFixedSidebarNav()}}},updateResponsiveTables:function(){this.updateResponsiveTables._contentWidth=this.$content.width();for(this.updateResponsiveTables._i=0;this.updateResponsiveTables._i<this.$collapsibleTables.length;this.updateResponsiveTables._i++){this.updateResponsiveTables._$table=a(this.$collapsibleTables[this.updateResponsiveTables._i]);this.updateResponsiveTables._check=false;if(typeof this.updateResponsiveTables._lastContentWidth!="undefined"){this.updateResponsiveTables._isLinear=this.updateResponsiveTables._$table.hasClass("collapsed");if(this.updateResponsiveTables._contentWidth>this.updateResponsiveTables._lastContentWidth){if(this.updateResponsiveTables._isLinear){this.updateResponsiveTables._$table.removeClass("collapsed");this.updateResponsiveTables._check=true}}else{if(!this.updateResponsiveTables._isLinear){this.updateResponsiveTables._check=true}}}else{this.updateResponsiveTables._check=true}if(this.updateResponsiveTables._check){if(this.updateResponsiveTables._$table.width()>this.updateResponsiveTables._contentWidth){this.updateResponsiveTables._$table.addClass("collapsed")}}}this.updateResponsiveTables._lastContentWidth=this.updateResponsiveTables._contentWidth},addLastVisibleNavItemToOverflowMenu:function(){this.navItems[this.visibleNavItems-1].prependTo(this.$overflowNavMenuList);this.visibleNavItems--},addFirstOverflowNavItemToMainMenu:function(){this.navItems[this.visibleNavItems].insertBefore(this.$overflowNavMenuItem);this.visibleNavItems++},onWindowScroll:function(){this.onWindowScroll._scrollTop=Garnish.$win.scrollTop();this.updateFixedNotifications();this.updateFixedSidebarNav()},updateFixedNotifications:function(){this.onWindowScroll._headerHeight=this.$header.height();if(this.onWindowScroll._scrollTop>this.onWindowScroll._headerHeight){if(!this.fixedNotifications){this.$notificationWrapper.addClass("fixed");this.fixedNotifications=true}}else{if(this.fixedNotifications){this.$notificationWrapper.removeClass("fixed");this.fixedNotifications=false}}},updateFixedSidebarNav:function(){if(this.showingSidebar&&this.$sidebarNav.length){if(this.fixedSidebarNav){this.onWindowScroll._$offsetTarget=this.$sidebarNavPlaceholder}else{this.onWindowScroll._$offsetTarget=this.$sidebarNav}if(this.onWindowScroll._scrollTop>this.onWindowScroll._$offsetTarget.offset().top){this.makeSidebarNavFixed();this.onWindowScroll._maxNavHeight=this.$main.offset().top+this.$main.outerHeight()-Garnish.$win.scrollTop();this.$sidebarNav.css("max-height",this.onWindowScroll._maxNavHeight)}else{this.makeSidebarNavUnfixed()}}},makeSidebarNavFixed:function(){if(!this.fixedSidebarNav){if(typeof $sidebarNavPlaceholder=="undefined"){this.$sidebarNavPlaceholder=a("<div/>")}this.$sidebarNavPlaceholder.insertBefore(this.$sidebarNav);this.$sidebarNav.addClass("fixed");this.fixedSidebarNav=true}},makeSidebarNavUnfixed:function(){if(this.fixedSidebarNav){this.$sidebarNavPlaceholder.remove();this.$sidebarNav.removeClass("fixed");this.fixedSidebarNav=false}},displayNotification:function(c,d){a('<div class="notification '+c+'">'+d+"</div>").appendTo(this.$notificationContainer).fadeIn("fast").delay(b.notificationDuration).fadeOut()},displayNotice:function(c){this.displayNotification("notice",c)},displayError:function(c){this.displayNotification("error",c)},selectTab:function(c){if(!this.selectedTab||c.currentTarget!=this.tabs[this.selectedTab].$tab[0]){if(this.selectedTab){this.tabs[this.selectedTab].$tab.removeClass("sel");this.tabs[this.selectedTab].$target.addClass("hidden")}var d=a(c.currentTarget).addClass("sel");this.selectedTab=d.attr("href");this.tabs[this.selectedTab].$target.removeClass("hidden")}},fetchAlerts:function(){var c={path:Craft.path};Craft.postActionRequest("app/getCpAlerts",c,a.proxy(this,"displayAlerts"))},displayAlerts:function(e){if(Garnish.isArray(e)&&e.length){this.$alerts=a('<ul id="alerts"/>').insertBefore(a("#header"));for(var d=0;d<e.length;d++){a("<li>"+e[d]+"</li>").appendTo(this.$alerts)}var c=this.$alerts.height();this.$alerts.height(0).animate({height:c},"fast",a.proxy(function(){this.$alerts.height("auto")},this));this.initAlerts()}},initAlerts:function(){var c=this.$alerts.find(".domain-mismatch:first");if(c.length){this.addListener(c,"click",a.proxy(function(f){f.preventDefault();if(confirm(Craft.t("Are you sure you want to transfer your license to this domain?"))){Craft.postActionRequest("app/transferLicenseToCurrentDomain",a.proxy(function(g){if(g.success){c.parent().remove();this.displayNotice(Craft.t("License transferred."))}else{if(g.error){var h=g.error}else{var h="An unknown error occurred."}alert(h)}},this))}},this))}var d=this.$alerts.find('a[class^="shun:"]');for(var e=0;e<d.length;e++){this.addListener(d[e],"click",a.proxy(function(g){g.preventDefault();var f=a(g.currentTarget);var h={message:f.prop("className").substr(5)};Craft.postActionRequest("app/shunCpAlert",h,a.proxy(function(i){if(i.success){f.parent().remove()}else{if(i.error){var j=i.error}else{var j="An unknown error occurred."}alert(j)}},this))},this))}}},{maxWidth:1051,navHeight:38,baseNavWidth:30,minSidebarWidth:768,hasSidebarClass:"has-sidebar",notificationDuration:2000});Craft.cp=new b()})(jQuery);